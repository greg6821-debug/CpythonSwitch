name: Build CPython 3.9 for Nintendo Switch

run-name: ${{ github.actor }} is building CPython for Switch ðŸš€

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Cache CPython sources
      uses: actions/cache@v4
      with:
        path: |
          cpython
          venv
        key: ${{ runner.os }}-cpython-${{ hashFiles('setup.bash', 'cpython.patch') }}
    
    - name: Set up devkitPro
      run: |
        # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº
        wget https://github.com/devkitPro/installer/releases/latest/download/devkitpro-pacman-installer.pkg.tar.xz
        sudo tar -xJf devkitpro-pacman-installer.pkg.tar.xz -C /
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ pacman Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð´Ð»Ñ Switch
        sudo dkp-pacman -Syu
        sudo dkp-pacman -S switch-dev devkitA64 libnx general-tools
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð¾Ð²
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "DEVKITA64=/opt/devkitpro/devkitA64" >> $GITHUB_ENV
        echo "PATH=$DEVKITA64/bin:$PATH" >> $GITHUB_ENV
    
    - name: Setup build environment
      run: |
        chmod +x setup.bash
        ./setup.bash
    
    - name: Build CPython for Switch
      run: |
        chmod +x build.bash
        ./build.bash
    
    - name: Build Switch NRO
      run: |
        cd switch
        make
    
    - name: Verify build artifacts
      run: |
        echo "Checking build artifacts..."
        ls -la python39-switch/sd_layout/python/lib/
        if [ -f switch/python_switch.nro ]; then
          echo "âœ“ NRO file built successfully"
          file switch/python_switch.nro
        else
          echo "âœ— NRO file not found!"
          exit 1
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-switch-build
        path: |
          python39-switch/sd_layout/
          switch/python_switch.nro
        retention-days: 7
