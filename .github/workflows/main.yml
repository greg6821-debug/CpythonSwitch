name: Build CPython 3.9 for Nintendo Switch

run-name: ${{ github.actor }} is building CPython for Switch ðŸš€

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Cache CPython source
      uses: actions/cache@v3
      with:
        path: cpython
        key: ${{ runner.os }}-cpython-3.9.22-${{ hashFiles('setup.bash') }}
        restore-keys: |
          ${{ runner.os }}-cpython-3.9.22-
    
    - name: Set up devkitPro
      run: |
        export DEVKITPRO=/opt/devkitpro
        echo "DEVKITPRO=$DEVKITPRO" >> $GITHUB_ENV
        
        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° devkitPro
        sudo mkdir -p $DEVKITPRO
        sudo chown -R $USER:$USER $DEVKITPRO
        
        wget -q https://github.com/devkitPro/pacman/releases/latest/download/devkitpro-pacman.deb
        sudo dpkg -i devkitpro-pacman.deb
        
        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
        sudo dkp-pacman -Syu --noconfirm \
          switch-dev \
          switch-portlibs \
          devkitA64 \
          aarch64-none-elf-binutils \
          aarch64-none-elf-gcc \
          aarch64-none-elf-newlib
        
        echo "/opt/devkitpro/portlibs/switch/lib" >> /etc/ld.so.conf
        sudo ldconfig
        
    - name: Set up build environment
      run: |
        chmod +x setup.bash
        ./setup.bash
        
    - name: Build CPython
      run: |
        chmod +x build.bash
        ./build.bash
        
    - name: Build NRO application
      run: |
        cd switch
        make -j$(nproc)
        
    - name: Create deployment package
      run: |
        mkdir -p dist
        mkdir -p dist/switch
        mkdir -p dist/sdmc
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ NRO
        cp switch/build/python_switch.nro dist/switch/
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Python Ð´Ð»Ñ SD-ÐºÐ°Ñ€Ñ‚Ñ‹
        cp -r sdmc/* dist/sdmc/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README
        cat > dist/README.txt << 'EOF'
        === Python 3.9 for Nintendo Switch ===
        
        Installation:
        1. Copy everything from 'sdmc/' folder to the root of your SD card
        2. Copy 'python_switch.nro' to /switch/ folder on your SD card
        3. Run from Homebrew Menu
        
        Structure on SD card:
        /sdmc/python/           - Python installation
        /sdmc/python/main.py    - Main script (can be modified)
        /switch/python_switch.nro - Python launcher
        
        To run your own scripts:
        1. Edit or replace sdmc:/python/main.py
        2. Or create new scripts in sdmc:/python/
        3. Import them from main.py
        
        Tested on: Atmosphere CFW, Firmware 16.0.0+
        EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-switch-build
        path: |
          dist/
          python39-switch/
        retention-days: 7
        
    - name: Create release archive
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        cd dist
        zip -r ../python-switch-release.zip .
        
    - name: Upload release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: python-switch-release.zip
