name: Build CPython 3.9 for Nintendo Switch

run-name: ${{ github.actor }} is building CPython for Switch ðŸš€

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DEVKITPRO: /opt/devkitpro
  DEVKITA64: /opt/devkitpro/devkitA64

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache devkitpro
      uses: actions/cache@v4
      with:
        path: /opt/devkitpro
        key: ${{ runner.os }}-devkitpro-${{ hashFiles('setup.bash') }}
    
    - name: Cache CPython source
      uses: actions/cache@v4
      with:
        path: cpython
        key: ${{ runner.os }}-cpython-${{ hashFiles('setup.bash') }}
    
    - name: Cache Python build
      uses: actions/cache@v4
      with:
        path: python39-switch
        key: ${{ runner.os }}-python-build-${{ hashFiles('build.bash', 'setup.bash') }}
    
    - name: Set up environment
      run: |
        chmod +x setup.bash
        ./setup.bash
        echo "${{ env.DEVKITA64 }}/bin" >> $GITHUB_PATH
        echo "${{ env.DEVKITPRO }}/tools/bin" >> $GITHUB_PATH
    
    - name: Build CPython for Switch
      run: |
        chmod +x build.bash
        ./build.bash
    
    - name: Build Switch NRO
      run: |
        cd switch
        make
        ls -la *.nro
    
    - name: Create SD card structure info
      run: |
        echo "SD card structure:" > sd_structure.txt
        echo "sdmc:/" >> sd_structure.txt
        echo "â”œâ”€â”€ python/" >> sd_structure.txt
        echo "â”‚   â”œâ”€â”€ bin/" >> sd_structure.txt
        echo "â”‚   â”œâ”€â”€ lib/" >> sd_structure.txt
        echo "â”‚   â”œâ”€â”€ include/" >> sd_structure.txt
        echo "â”‚   â””â”€â”€ share/" >> sd_structure.txt
        echo "â””â”€â”€ switch/" >> sd_structure.txt
        echo "    â””â”€â”€ python_switch.nro" >> sd_structure.txt
        echo "" >> sd_structure.txt
        echo "Copy these files to SD card:" >> sd_structure.txt
        echo "1. Copy entire python39-switch/ to sdmc:/python/" >> sd_structure.txt
        echo "2. Copy switch/python_switch.nro to sdmc:/switch/" >> sd_structure.txt
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-switch-build
        path: |
          python39-switch/
          switch/python_switch.nro
          switch/python_switch.elf
          sd_structure.txt
        retention-days: 7
    
    - name: Create release package
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        mkdir -p release
        cp -r python39-switch release/
        cp switch/python_switch.nro release/
        cp sd_structure.txt release/
        cd release
        tar czf python-switch-$(date +%Y%m%d).tar.gz *
        cd ..
    
    - name: Upload release package
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: python-switch-release
        path: release/python-switch-*.tar.gz
        retention-days: 30
