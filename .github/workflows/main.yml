name: Build CPython 3.9 for Switch

run-name: ${{ github.actor }} is building CPython for Switch ðŸš€

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install base packages
      run: |
        apt-get update
        apt-get install -y \
          build-essential \
          curl wget git \
          p7zip-full \
          python3 \
          ca-certificates \
          xz-utils

    - name: Install devkitPro (official)
      run: |
        export DEVKITPRO=/opt/devkitpro
        mkdir -p $DEVKITPRO
        curl -L https://apt.devkitpro.org/install-devkitpro-pacman | bash

    - name: Install Switch toolchain & libs
      run: |
        export DEVKITPRO=/opt/devkitpro
        export PATH=$DEVKITPRO/tools/bin:$PATH

        dkp-pacman -Sy --noconfirm \
          devkitA64 \
          libnx \
          switch-zlib \
          switch-libjpeg-turbo \
          switch-libpng \
          switch-freetype

    - name: Verify environment
      run: |
        export DEVKITPRO=/opt/devkitpro
        source $DEVKITPRO/switchvars.sh
        which aarch64-none-elf-gcc
        ls $DEVKITPRO/libnx/lib/libnx.a
        find $DEVKITPRO -name libnx.specs

    - name: Prepare ROMFS
      run: |
        mkdir -p switch/romfs/lib
        cp -r python39-switch/lib/python3.9 switch/romfs/lib
        cp tests/renpy_smoketest.py switch/romfs/

    - name: Build .nro
      shell: bash
      run: |
        export DEVKITPRO=/opt/devkitpro
        source $DEVKITPRO/switchvars.sh

        cd switch
        rm -rf build
        mkdir build

        aarch64-none-elf-gcc \
          -I../python39-switch/include/python3.9 \
          -I$DEVKITPRO/libnx/include \
          -O2 \
          source/main.c \
          ../python39-switch/lib/libpython3.9.a \
          -L$DEVKITPRO/libnx/lib \
          -L$DEVKITPRO/portlibs/switch/lib \
          -specs=libnx.specs \
          -lz -lm \
          -o build/python39-test.elf

        nacptool --create "Python 3.9 Test" "CPythonSwitch" "0.1.0" build/python39-test.nacp
        elf2nro build/python39-test.elf build/python39-test.nro \
          --nacp=build/python39-test.nacp \
          --romfsdir=romfs

    - name: Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: switch-nro
        path: switch/build/*.nro
